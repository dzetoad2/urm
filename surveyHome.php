<?phptry {    require_once 'urm_secure/functions.php';    require_once 'urm_secure/facilityFunctions.php';    require_once 'urm_secure/facilityTypeFunctions.php';    require_once 'urm_secure/myFacilitiesFunctions.php';    require_once 'urm_secure/customFacilityFunctions.php';    require_once 'urm_secure/surveyHomeFunctions.php';    require_once 'urm_secure/sessionStateFunctions.php';    if (!loggedin()) {        //echo "userarea but not loggedin!<br/>\n";        header("Location: login.php");        exit();    }    if (!isset($_SESSION['username']) || !isset($_SESSION['userid'])) {        $errorMsg = "error: un or userid not set";        throwMyExc($errorMsg);    }    $un = $_SESSION['username'];    $userId = $_SESSION['userid'];    savePostAndSessionVars($userId, $_POST, $_SESSION, "surveyHome.php");    if (isset($_SESSION['userFacilityId']))        unset($_SESSION['userFacilityId']);    if (isset($_SESSION['customFacilityId']))        unset($_SESSION['customFacilityId']);//------------------- NOW GET ALL THE ROW DATA , THIS IS AFTER ALL CHANGES HAVE BEEN UPDATED.---------------    $atLeastOneSurveyCategoryIsCompleteForAllFacilities = false;    $myFrDao = getMyFacilitiesRowsHtml_WithStatus($userId);    $myCFrDao = getMyCustomFacilitiesRowsHtml_WithStatus($userId);    $myFacilitiesRows = $myFrDao->o;    $myCustomFacilitiesRows = $myCFrDao->o;    //     if ($myFrDao->atLeastOneSurveyCategoryIsCompleteForAll === true && $myCFrDao->atLeastOneSurveyCategoryIsCompleteForAll === true) {        $atLeastOneSurveyCategoryIsCompleteForAllFacilities = true;    }//debug.    ?>    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">    <html xmlns="http://www.w3.org/1999/xhtml">        <head>            <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />            <title>Survey Home</title>            <link rel="stylesheet" type="text/css" href="css/reset-min.css"/>            <link rel="stylesheet" type="text/css" href="css/styles.css" />            <link rel="stylesheet" type="text/css" href="css/tables.css" />            <!--<link rel="stylesheet" href="css/jqueryui/1.7.1/themes/blitzer/jquery-ui.css" type="text/css" />-->            <link rel="stylesheet" href="js/jquery.alerts-1.1/jquery.alerts.css" type="text/css" />            <script type="text/javascript" src="js/jquery-1.6.2.min.js"></script>            <script src="js/jquery.alerts-1.1/jquery.alerts.js"></script>            <script type="text/javascript" src="js/tables.js"></script>            <script type="text/javascript">                                                         $(document).ready(function() {                    // THIS SETS THE UNDEFINED BOXES TO YELLOW.                    $('td[id$="0"]').css("background-color","yellow");        	                       $("a#clearFacilitiesLink").click(function(e) {                        e.preventDefault();                        alert("Clearing all of your user's facility entries");                        document.forms["clearFacilitiesForm"].submit();                    });                    $("a#clearCustomFacilitiesLink").click(function(e) {                        e.preventDefault();                        alert("Clearing all of your user created facility entries");                        document.forms["clearCustomFacilitiesForm"].submit();                    });                    $(".userFacilityRow").click(function() {                        var rowId = $(this).closest(".userFacilityRow").attr("id");                        var name = $(this).closest(".userFacilityRow").children(".nameCell:first").attr("id");                        //		     alert("Facility: "+name +" was chosen.");                        //now add to the form 'chooseAction' and submit it.                        $("#chooseAction").children("input#userFacilityId").val(rowId);                        //		     $("#chooseAction").children("input#facilityName").val(name);        		                             //$.post("userarea.php", { id: rowId, source: "chooseFacility" } );                        document.forms["chooseAction"].submit();                    });                    $(".customFacilityRow").click(function() {                        var rowId = $(this).closest(".customFacilityRow").attr("id");                        var name = $(this).closest(".customFacilityRow").children(".nameCell:first").attr("id");                        //		     alert("Facility: "+name +" was chosen.");                        //now add to the form 'chooseAction' and submit it.                        $("#chooseAction2").children("input#customFacilityId").val(rowId);                        //		     $("#chooseAction2").children("input#facilityName").val(name);        		                             //$.post("userarea.php", { id: rowId, source: "chooseFacility" } );                        document.forms["chooseAction2"].submit();                    });                    $("#doneWithAllFacilitiesButton").click(function(e) {                        //javascript popup, yes or no.                        //var answer = confirm(" bla?")                        //jAlert('Confirmed true: ' + r, 'Confirmation Results');                        jConfirm('Done with all surveys in all facilities - Log me out:  Are you sure?', 'Confirm', function(r) {                            if(r == true){                                window.location = 'surveyFinished.php';                                //jAlert('Confirmed true: ' + r, 'Confirmation Results');                            }                            else{                                //window.location = 'surveyHome.php';                                //jAlert('Confirmed false: ' + r, 'Confirmation Results');                            }                        });                        e.preventDefault();                    });                });            </script>        </head>        <body>            <?php// include the top header bar            include("includes/header.php");            ?>            <h3>Survey Home </h3>            <div>                <p>                     <b>Survey Home</b> - After completing the "Choose Facilities" section, you will find them listed here.                     These are the facilities for which you will provide data.                     Select the facility for data entry by hovering your mouse over the facility then clicking on it.                </p>                <h4>My Facilities:</h4>                <p>Click on a facility to see its survey categories.</p>                <table>                    <thead>                        <tr>                             <?php if (defined('DEBUG')) { ?>                                <th>Id</th>                            <?php } ?>                            <th>Name</th>                            <th>Street Address</th>                            <th>City</th>                            <th>State</th>                            <th>Zip Code</th>                            <th>Facility Type</th>                            <th>Survey<br/>Completion<br/>Status</th>                        </tr>                    </thead>                    <tbody>                        <?php                        echo $myFacilitiesRows;  // identified by "userFacilityRow" in a cell.                        ?>                    </tbody>                </table>            </div>            <div>                <h4>My User Created Facilities:</h4>                <p>Click on a user created facility to see its survey categories.</p>                <table>                    <thead>                         <tr>                             <?php if (defined('DEBUG')) { ?>                                <th>Id</th>                            <?php } ?>                            <th>Name</th>                            <th>Street Address</th>                            <th>City</th>                            <th>State</th>                            <th>Zip Code</th>                            <th>Facility Type</th>                            <th>Survey<br/>Completion<br/>Status</th>                        </tr>                    </thead>                    <tbody>                        <?php                        echo $myCustomFacilitiesRows;  // identified by "customFacilityRow" in a cell.                        ?>                    </tbody>                </table>            </div>            <?php if ($atLeastOneSurveyCategoryIsCompleteForAllFacilities === true) { ?>                <p class="buttonParagraph">                     <a href="#" class="doneSurvCatbutton_link" id="doneWithAllFacilitiesButton" >Done with all surveys in all facilities - Log me out</a>                </p>            <?php } ?>            <p class="footerNav"><a href="home.php">Home</a></p>            <form id="chooseAction" name="chooseAction"                  action="surveyCategories.php" method="post"><input type="hidden"                                                               id="userFacilityId" name="userFacilityId" value="nothing" />             </form>            <form id="chooseAction2" name="chooseAction2"                  action="surveyCategories.php" method="post"><input type="hidden"                                                               id="customFacilityId" name="customFacilityId" value="nothing" />             </form>        </body>    </html>    <?php} catch (Exception $e) {    goErrorPage($e);}?>